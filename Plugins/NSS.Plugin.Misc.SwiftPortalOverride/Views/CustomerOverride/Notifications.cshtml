@using Nop.Core
@using NSS.Plugin.Misc.SwiftPortalOverride.Models
@using NSS.Plugin.Misc.SwiftCore.Helpers
@using NSS.Plugin.Misc.SwiftPortalOverride
@using NSS.Plugin.Misc.SwiftCore.Services
@using Nop.Services.Common
@using Nop.Web.Framework.Themes
@model Notification
@inject Nop.Core.IWebHelper webHelper
@inject IThemeContext themeContext
@inject IWorkContext workContext
@inject IGenericAttributeService genericAttributeService
@inject ICustomerCompanyService customerCompanyService

@{
    Layout = "_ColumnsTwo";

    //title
    Html.AddTitleParts(T("PageTitle.Account").Text);
    //page class
    Html.AppendPageCssClassParts("html-account-page");
    Html.AppendPageCssClassParts("html-customer-info-page");
}

@{
    var compIdCookieKey = string.Format(SwiftPortalOverrideDefaults.ERPCompanyCookieKey, workContext.CurrentCustomer.Id);
    int eRPCompanyId = Common.GetSavedERPCompanyIdFromCookies(Context.Request.Cookies[compIdCookieKey]);
    bool isBuyer = customerCompanyService.Authorize(workContext.CurrentCustomer.Id, eRPCompanyId, ERPRole.Buyer);
}

@{ var themeName = themeContext.WorkingThemeName; }

@section left
{
    @await Component.InvokeAsync("CustomCustomerNavigation", new { selectedTabId = CustomerNavigationEnum.NotificationPreferences, isABuyer = isBuyer })
}


<div id="notifications" class="page account-page customer-info-page">
    <div class="page-body">
        <div class=account-page-card>
            <div class="title">
                <strong>NOTIFICATIONS</strong>
                <a v-on:click="enableAllNotifications" class="notification-all">Enable all notifications</a>
            </div>

            <div class=notification-group>
                <div class="notification-top">
                    <p>My Orders</p>
                    <div class="action-titles">
                        <p>Email</p>
                        <p>SMS</p>
                    </div>
                </div>
                <div class="notification" v-for="preference in preferences">
                    <p>{{preference.title}}</p>
                    <div class="notification-actions">
                        <div>
                            <label>
                                <input type="checkbox" hidden v-model="preference.isEmail">
                                <img :src="preference.isEmail ? '/Themes/@themeName/Content/assets/mail-dark.svg' : '/Themes/@themeName/Content/assets/mail.svg'" alt="mail-icon">
                            </label>
                        </div>
                        <div>
                            <label>
                                <input type="checkbox" hidden v-model="preference.isSms">
                                <img :src="preference.isSms ? '/Themes/@themeName/Content/assets/mobile-phone-dark.svg' : '/Themes/@themeName/Content/assets/mobile-phone.svg'" alt="sms-icon">
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="buttons save-customer-info-button notification-btn">
                <input type=submit v-on:click="updatePreferences"
                       id=save-info-button value='Update Preferences' name=save-info-button
                       class="button-2 ">
            </div>
        </div>
    </div>
</div>

<script>
    var vm = new Vue({
        el: '#notifications',
        data: {
            preferences: []
        },
        mounted: function () {
            this.updatePreferences();
        },
        methods: {
            showLoading: function () {
            },
            hideLoading: function () {
            },
            updatePreferences: function () {
                console.log('request', this.preferences);
                const request = this.preferences;
                this.showLoading();
                $("#overlay").css("display", "flex");
                const self = this;
                $.ajax({
                    url: "@Url.Action("UpdateNotifications", "CustomerOverride")",
                    type: 'POST',
                    contentType: 'application/json; charset=utf-8',
                    data: JSON.stringify(request),
                    success: function (data) {
                        self.hideLoading();
                        self.preferences = [
                            {
                                title: "Notify me when my order has been confirmed (offline orders only)",
                                isEmail: true,
                                isSms: false

                            },
                            {
                                title: "Notify me when my order has a scheduled date change",
                                isEmail: true,
                                isSms: true
                            },
                            {
                                title: "Notify me when my order promise date change",
                                isEmail: false,
                                isSms: true
                            },
                            {
                                title: "Notify me when my order is ready",
                                isEmail: false,
                                isSms: false
                            }
                        ]
                        console.log('success-data', self.preferences);
                    },
                    error: function (xhr, thrownError) {
                        self.hideLoading();
                        console.log('error-data', data);
                        $("#overlay").css("display", "none");
                    }
                });
            },
            enableAllNotifications: function () {
                this.preferences.forEach(function (item) {
                    item.isEmail = true;
                    item.isSms = true;
                })
                const request = {
                };
                this.showLoading();
                $("#overlay").css("display", "flex");

                console.log('request', request);
                const self = this;
                $.ajax({
                    url: "@Url.Action("UpdateNotifications", "CustomerOverride")",
                    type: 'POST',
                    contentType: 'application/json; charset=utf-8',
                    data: JSON.stringify(request),
                    success: function (data) {
                        self.hideLoading();
                        //console.log('success-data', data);
                        //self.isMyOrderConfirmedEmail = data.isMyOrderConfirmedEmail;
                    },
                    error: function (xhr, thrownError) {
                        self.hideLoading();
                        console.log('error-data', data);
                        $("#overlay").css("display", "none");
                    }
                });
            }
        },
    });
</script>