@using Nop.Core
@using Nop.Web.Models.Customer
@using NSS.Plugin.Misc.SwiftCore.Helpers
@using NSS.Plugin.Misc.SwiftPortalOverride
@using NSS.Plugin.Misc.SwiftCore.Services
@using Nop.Services.Common
@model CustomerInfoModel
@inject Nop.Core.IWebHelper webHelper
@inject IWorkContext workContext
@inject IGenericAttributeService genericAttributeService
@inject ICustomerCompanyService customerCompanyService

@{
    Layout = "_ColumnsTwo";

    //title
    Html.AddTitleParts(T("PageTitle.Account").Text);
    //page class
    Html.AppendPageCssClassParts("html-account-page");
    Html.AppendPageCssClassParts("html-customer-info-page");
}

@{
    var compIdCookieKey = string.Format(SwiftPortalOverrideDefaults.ERPCompanyCookieKey, workContext.CurrentCustomer.Id);
    int eRPCompanyId = Common.GetSavedERPCompanyIdFromCookies(Context.Request.Cookies[compIdCookieKey]);
    bool isBuyer = customerCompanyService.Authorize(workContext.CurrentCustomer.Id, eRPCompanyId, ERPRole.Buyer);
}



@section left
    {
    @await Component.InvokeAsync("CustomCustomerNavigation", new { selectedTabId = CustomerNavigationEnum.Info, isABuyer = isBuyer })
}

@{
    var customer = workContext.CurrentCustomer;
    int ErpId = genericAttributeService.GetAttribute<int>(customer, Constants.ErpKeyAttribute);

    string CellPhone = genericAttributeService.GetAttribute<string>(customer, Constants.CellAttribute);
}

<div class="page account-page customer-info-page">
    <div class="page-body">
        <form asp-route="CustomerInfo" method="post">
            <div class="account-page-card">
                <div class="title"><strong>PERSONAL INFORMATION</strong></div>
                <div asp-validation-summary="ModelOnly" class="message-error"></div>
                <div class="form-fields">
                    <div class="input-block">
                        <label asp-for="FirstName" asp-postfix=":">First Name</label>
                        @if (Model.FirstNameRequired)
                        {
                            <nop-required />
                        }
                        <input asp-for="FirstName" class="form-control custom-input" />
                        <span asp-validation-for="FirstName"></span>
                    </div>

                    <div class="">
                        <label asp-for="LastName" asp-postfix=":">Last Name</label>
                        @if (Model.LastNameRequired)
                        {
                            <nop-required />
                        }
                        <input asp-for="LastName" class="form-control custom-input" />
                        <span asp-validation-for="LastName"></span>
                    </div>



                    <div class="">
                        <label asp-for="Phone" asp-postfix=":">Work Phone</label>
                        <input asp-for="Phone" class="form-control custom-input" />
                        <span asp-validation-for="Phone"></span>
                    </div>

                    <div class="">
                        <label asp-for="Phone" asp-postfix=":">Cell Phone</label>
                        <input name="cell-phone" id="cell-phone" class="form-control custom-input" value="@CellPhone" />
                        <span asp-validation-for="Phone"></span>
                    </div>

                    <div class="">
                        <label asp-for="Email" asp-postfix=":">Work Email</label>
                        <input asp-for="Email" class="form-control custom-input" style="cursor:unset" readonly />
                    </div>

                    @if (Model.CompanyEnabled)
                    {
                        <div class="">
                            <label asp-for="Company" asp-postfix=":">Company Name</label>
                            <input asp-for="Company" class="form-control custom-input" style="cursor:unset" readonly />
                            @*<label class="form-control custom-input" style="cursor:unset" asp-for="Company" readonly>@Model.Company</label>*@
                        </div>
                    }

                    @if (!String.IsNullOrEmpty(ErpId.ToString()))
                    {
                        <div class="">
                            <label>Customer Number</label>
                            <label class="form-control custom-input" style="cursor:unset" readonly>@ErpId</label>
                        </div>
                    }


                    @if (Model.CustomerAttributes.Count > 0)
                    {
                        @await Html.PartialAsync("_CustomerAttributes", Model.CustomerAttributes);
                    }

                </div>
                <div class="buttons save-customer-info-button">
                    <input type=submit id=save-info-button value='Save Changes' name=save-info-button class="button-2 ">
                </div>
            </div>
        </form>
    </div>
</div>
<script asp-location="Footer">
    function removeexternalassociation(itemId) {
        if (confirm('@T("Common.AreYouSure")')) {
            var postData = {
                id: itemId
            };
            addAntiForgeryToken(postData);
            $.ajax({
                cache: false,
                type: "POST",
                url: "@Url.Action("RemoveExternalAssociation", "Customer")",
                data: postData,
                dataType: "json",
                success: function (data, textStatus, jqXHR) {
                    location.href = data.redirect;
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    alert('Failed to delete');
                }
            });
        }
        return false;
    }
</script>
