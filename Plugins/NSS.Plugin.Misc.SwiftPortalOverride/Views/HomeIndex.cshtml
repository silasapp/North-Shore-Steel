@using NSS.Plugin.Misc.SwiftPortalOverride.Models
@using Nop.Web.Framework.Themes
@using NSS.Plugin.Misc.SwiftPortalOverride
@using NSS.Plugin.Misc.SwiftCore.Helpers
@using NSS.Plugin.Misc.SwiftCore.Services
@using Nop.Core
@using Nop.Services.Common
@using Syncfusion.EJ2

@model TransactionModel
@inject IThemeContext themeContext
@inject IWorkContext workContext
@inject IGenericAttributeService genericAttributeService
@inject ICustomerCompanyService customerCompanyService

@{
    Layout = "_ColumnsOne";

    //title
    Html.AddTitleParts("Home");
    //page class
    Html.AppendPageCssClassParts("html-home-page");
    Html.AddCssFileParts("~/Plugins/Misc.SwiftPortalOverride/Content/home.css");
}

@{
    var themeName = themeContext.WorkingThemeName;
    var currentCustomer = workContext.CurrentCustomer;
    var compIdCookieKey = string.Format(SwiftPortalOverrideDefaults.ERPCompanyCookieKey, currentCustomer.Id);
    string eRPCompanyId = genericAttributeService.GetAttribute<string>(currentCustomer, compIdCookieKey);
    bool isAP = customerCompanyService.Authorize(currentCustomer.Id, Convert.ToInt32(eRPCompanyId), ERPRole.AP);
    bool isOperations = customerCompanyService.Authorize(currentCustomer.Id, Convert.ToInt32(eRPCompanyId), ERPRole.Operations);
    bool isBuyer = customerCompanyService.Authorize(currentCustomer.Id, Convert.ToInt32(eRPCompanyId), ERPRole.Buyer);
}


@functions{
    @using Newtonsoft.Json.Serialization;
    @using Newtonsoft.Json;

    string Serialize(object input)
    {
        return JsonConvert.SerializeObject(input, new JsonSerializerSettings
        {
            ContractResolver = new DefaultContractResolver { NamingStrategy = new CamelCaseNamingStrategy() },
            Formatting = Formatting.None
        });
    }
}


<style>
    .m-b2 {
        margin-bottom: 2rem;
    }

    .p-b2 {
        padding-bottom: 2.2rem;
    }

    .p-b1 {
        padding-bottom: 1.7rem;
    }

    .p-b3 {
        padding-bottom: 2.7rem;
    }

    .p-b11 {
        padding-bottom: 11.1rem;
    }
    /*.w-11 {
        width: 11rem;
    }*/

</style>


<div id="app" class="page home-page">
@{

    Func<object, object>
    Content1 =
    @<div id="viewMtrModal">
        <div class="d-flex flex-column mb-2">
            <template v-for="p in orderMTRs">
                <a v-bind:href="p.MtrFile" target="_blank" class="text-decoration-none">
                    <div class="d-flex flex-row mt-4 cursor-pointer">
                        <label class="h4-primary mb-0 ml-1 cursor-pointer">View MTR {{p.MtrId}}</label>
                    </div>
                </a>
            </template>
        </div>
    </div>;
}
    <div class="page-body">
        <div class="d-none d-md-block">
            <div class="row">
                @if (isOperations || isBuyer)
                {
                    <div class="col-md-4 col-sm-6 col-12 m-b2">
                        <div class="tab-content" id="pills-tabContent">
                            <div class="responsive-table-container tab-pane fade show active" id="" role="tabpanel" aria-labelledby="">
                                <label class="h4 text-primary font-weight-bold mb-4">OPEN ORDERS</label>
                                @if (Model.OpenOrders != null && Model.OpenOrders.Count > 0)
                                {
                                    <table class="table table-striped w3-animate-left nss-table">
                                        <thead class="thead-default">
                                            <tr>
                                                <td scope="col">Order #</td>
                                                <td scope="col">Delivery Date</td>
                                                <td scope="col">Status</td>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var order in Model.OpenOrders)
                                            {
                                                <tr>
                                                    <td><a href="/orders/@order.OrderId" scope="row">@order.OrderId</a></td>
                                                    <td>@order.DeliveryDate?.ToString("MM/dd/yyyy")</td>
                                                    <td>@order.OrderStatusName</td>
                                                </tr>
                                            }

                                        </tbody>
                                    </table>
                                    <label>* All orders display the five most recent result from the past 30 day.</label>
                                }
                                else
                                {
                                    <div class="text-center pt-5 p-b11">
                                        <label>You have not placed an order in the last 30 days.</label>
                                        <div class="action pt-3">
                                            <a href="/catalog">
                                                <button class="swift-color-btn">
                                                    <img src="~/Themes/@themeName/Content/assets/menu.svg" height="20" width="20" alt=""> SHOP SWIFT&#8482;
                                                </button>
                                            </a>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>


                    <div class="col-md-5 col-sm-6 col-12 m-b2">
                        <div class="tab-content" id="pills-tabContent">
                            <div class="responsive-table-container tab-pane fade show active" id="" role="tabpanel" aria-labelledby="">
                                <label class="h4 text-primary font-weight-bold mb-4">CLOSED ORDERS</label>
                                <table class="table table-striped w3-animate-left nss-table">
                                    <thead class="thead-default">
                                        <tr>
                                            <td scope="col">Order #</td>
                                            <td scope="col">Delivery Date</td>
                                            <td scope="col" class="text-center">On-Time Delivery</td>
                                            <td scope="col" class="text-center">MTR/POD</td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @if (Model.ClosedOrders != null && Model.ClosedOrders.Count > 0)
                                        {
                                            foreach (var order in Model.ClosedOrders)
                                            {
                                                <tr>
                                                    <td><a href="/orders/@order.OrderId" scope="row">@order.OrderId</a></td>
                                                    <td>@order.DeliveryDate?.ToString("MM/dd/yyyy")</td>
                                                    <td class="text-center">@order.OrderStatusName???</td>
                                                    <td class="text-center cursor-pointer">
                                                        <img alt="MTR Icon" v-on:click="handleMtrModal(@eRPCompanyId, @order.OrderId)" src="/Themes/@themeName/Content/assets/invoice.svg" />
                                                    </td>
                                                </tr>
                                            }
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                }

                <div class="col-md-3 col-sm-6 col-12 m-b2">
                    <div class="card p-b3">
                        <div class="card-body text-center contact-card">
                            <div class="avatar-block">
                                <img class="avatar rounded-circle" src="~/Themes/@(themeName)/Content/images/call-avatar.png" alt="profile-default">
                            </div>
                            <h6 class="h4-primary-600-teko mb-2 mt-2 mx-3">Outstanding</h6>
                            <h6 class="h4-primary-600-teko mb-3 mx-3">Customer Service</h6>
                            <h6 class="h5-default">I'm here to provide you with</h6>
                            <h6 class="h5-default mb-3">exceptional customer service.</h6>
                            <div class="d-flex flex-row align-items-center justify-content-center pb-2" v-on:click="isCustomerServiceOpen = !isCustomerServiceOpen">
                                <label class="fs12-default mb-0">Business Hours</label>
                                <img src="~/Themes/@(themeName)/Content/assets/icn-arrow-up.svg" class="ml-2" v-bind:style="{'transform': isCustomerServiceOpen ? '' : 'rotate(180deg)'}" alt="arrow up" width="20">
                            </div>
                            <div v-if="isCustomerServiceOpen">
                                <div class="d-flex flex-column align-items-center justify-content-center my-2">
                                    <div class="d-flex flex-row w-100">
                                        <label class="h5-primary-600-sans w-25 w-lg-40 text-right mr-3">Mon</label>
                                        <label class="h5-primary-600-sans">8:00am - 5:00pm</label>
                                    </div>
                                    <div class="d-flex flex-row w-100">
                                        <label class="h5-primary-600-sans w-25 w-lg-40 text-right mr-3">Tue</label>
                                        <label class="h5-primary-600-sans">8:00am - 5:00pm</label>
                                    </div>
                                    <div class="d-flex flex-row w-100">
                                        <label class="h5-primary-600-sans w-25 w-lg-40 text-right mr-3">Wed</label>
                                        <label class="h5-primary-600-sans">8:00am - 5:00pm</label>
                                    </div>
                                    <div class="d-flex flex-row w-100">
                                        <label class="h5-primary-600-sans w-25 w-lg-40 text-right mr-3">Thur</label>
                                        <label class="h5-primary-600-sans">8:00am - 5:00pm</label>
                                    </div>
                                    <div class="d-flex flex-row w-100">
                                        <label class="h5-primary-600-sans w-25 w-lg-40 w-lg-40 text-right mr-3">Fri</label>
                                        <label class="h5-primary-600-sans">8:00am - 5:00pm</label>
                                    </div>
                                    <div class="d-flex flex-row w-100">
                                        <label class="h5-primary-600-sans w-25 w-lg-40 text-right mr-3">Sat</label>
                                        <label class="h5-primary-600-sans">Closed</label>
                                    </div>
                                    <div class="d-flex flex-row w-100">
                                        <label class="h5-primary-600-sans w-25 w-lg-40 text-right mr-3">Sun</label>
                                        <label class="h5-primary-600-sans">Closed</label>
                                    </div>
                                </div>
                            </div>
                            <div class="contact-container">
                                <a href=tel:@Model.CompanyInfo.SalesContact?.Phone class="btn contact-btn">
                                    <img src="~/Themes/@(themeName)/Content/assets/phone.svg" alt="">
                                    <label class="fs12-default mb-0 ml-1">@Model.CompanyInfo.SalesContact?.Phone</label>
                                </a>
                                <a href=mailto:@Model.CompanyInfo.SalesContact?.Email class="btn contact-btn">
                                    <img src="~/Themes/@(themeName)/Content/assets/mail.svg" alt="">
                                    <label class="fs12-default mb-0 ml-1">@Model.CompanyInfo.SalesContact?.Email</label>
                                </a>
                            </div>

                        </div>
                    </div>
                </div>

                @if (isOperations)
                {

                    <div class="col-md-7 col-sm-6 col-12 m-b2">
                        <div class="tab-content" id="pills-tabContent">
                            <div class="tab-pane fade show active" id="" role="tabpanel" aria-labelledby="">
                                <label class="h4 text-primary font-weight-bold mb-4">ORDER STATISTICS</label>
                                <div class="row">
                                    <div class="col-md-4 text-center mb-3">
                                        <label class="w-11">YTD $ Sales</label>
                                        <h5>$10,000.00</h5>
                                    </div>
                                    <div class="col-md-4 text-center mb-3">
                                        <label class="w-11">YTD Lbs. Shipped</label>
                                        <h5>200,000</h5>
                                    </div>
                                    <div class="col-md-4 text-center mb-3">
                                        <label class="w-11">YTD % On-Time Sales Orders Delivered</label>
                                        <h5>200,000</h5>
                                    </div>
                                    <div class="col-md-4 text-center mb-3">
                                        <label class="w-11">YTD Total Discounts Earned</label>
                                        <h5>$10,000.00</h5>
                                    </div>
                                    <div class="col-md-4 text-center mb-3">
                                        <label class="w-11">YTD Number of Sales Orders Shipped</label>
                                        <h5>200,000</h5>
                                    </div>
                                    <div class="col-md-4 text-center mb-3">
                                        <label class="w-11">Number of Sales Orders Currently Booked</label>
                                        <h5>2</h5>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }


                @if (isAP || isBuyer)
                {
                    <div class="col-md-5 col-sm-6 col-12 m-b2">
                        <div class="tab-content p-b1" id="pills-tabContent">
                            <div class=" tab-pane fade show active" id="" role="tabpanel" aria-labelledby="">
                                <label class="h4 text-primary font-weight-bold mb-4">CREDIT SUMMARY</label>
                                <div class="row">
                                    <div class="col-md-4 text-center mb-3">
                                        <label>Credit Limit</label>
                                        <h5>$@DoFormat(Model.CreditSummary.CreditLimit)</h5>
                                    </div>
                                    <div class="col-md-4 text-center mb-3">
                                        <label>Total Open Invoices</label>
                                        <h5>$@DoFormat(Model.CreditSummary.OpenInvoiceAmount)</h5>
                                    </div>
                                    <div class="col-md-4 text-center mb-3">
                                        <label>Total Past Due</label>
                                        <h5 style="color: red;">$@DoFormat(Model.CreditSummary.PastDueAmount)</h5>
                                    </div>
                                    <div class="col-md-4 text-center mb-3">
                                        <label>Open Credit</label>
                                        <h5>$@DoFormat(Model.CreditSummary.CreditAmount)</h5>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                }

                 @Html.EJS().Dialog("dialog").Visible(false).IsModal(true).Created("onDialogCreated").Header("<span class='dialog-header'>VIEW MTRS</span>").ContentTemplate(@Content1).ShowCloseIcon(true).Visible(false).Width("450px").Target("body").Render();
            </div>
            <div class="discount-block" alt="">
                <img src="~/Themes/@(themeName)/Content/assets/discount.PNG" alt="">
                <div class="action">
                    <button class="white-btn">
                        <img src="~/Themes/@(themeName)/Content/assets/menu.svg" height="20"
                             width="20" alt=""> SHOP SWIFT&#8482;
                    </button>
                </div>
            </div>
        </div>


        <div class="d-md-none">
            <ul class="nav nav-pills mb-1 mt-5 mx-4" id="pills-tab" role="tablist">
                <li class="nav-item" role="presentation" style="margin-right: 0.3em" v-on:click="showRecentOrders = true;">
                    <a class="nav-link" v-bind:class="{'active': showRecentOrders}">Open Orders</a>
                </li>
                <li class="nav-item" role="presentation" v-on:click="showRecentOrders = false;">
                    <a class="nav-link" v-bind:class="{'active': !showRecentOrders}">Closed Orders</a>
                </li>
            </ul>

            <div class="mt-2 mx-4">
                <div v-if="showRecentOrders">
                    <div v-for="order in openOrders" class="d-flex flex-column bg-white-shadow mb-3">
                        <div class="d-flex flex-row">
                            <div class="d-flex bg-primary p-2 home-table-sm-header">
                                <label class="fs12-white mb-0">Order #</label>
                            </div>
                            <div class="d-flex p-2">
                                <a v-bind:href="'/orders/' + order.orderId" class="fs12-link">{{ order.orderId }}</a>
                            </div>
                        </div>
                       
                        <div class="d-flex flex-row">
                            <div class="d-flex bg-primary p-2 home-table-sm-header">
                                <label class="fs12-white mb-0">Est. Delivery</label>
                            </div>
                            <div class="d-flex p-2">
                                <label class="fs12-default mb-0">{{ order.DeliveryDate | date }}</label>
                            </div>
                        </div>
                        <div class="d-flex flex-row">
                            <div class="d-flex bg-primary p-2 home-table-sm-header">
                                <label class="fs12-white mb-0">Status</label>
                            </div>
                            <div class="d-flex p-2">
                                <label class="fs12-default mb-0">{{ order.orderStatusName }}</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div v-if="!showRecentOrders">
                    <div v-for="invoice in closedOrders" class="d-flex flex-column bg-white-shadow mb-3">
                        <div class="d-flex flex-row">
                            <div class="d-flex bg-primary p-2 home-table-sm-header">
                                <label class="fs12-white mb-0">Invoice #</label>
                            </div>
                            <div class="d-flex p-2">
                                <a class="fs12-link">{{ invoice.invoiceId }}</a>
                            </div>
                        </div>
                        <div class="d-flex flex-row">
                            <div class="d-flex bg-primary p-2 home-table-sm-header">
                                <label class="fs12-white mb-0">Order #</label>
                            </div>
                            <div class="d-flex p-2">
                                <a v-bind:href="'/invoices/' + invoice.orderNo" class="fs12-link">{{ invoice.orderNo }}</a>
                            </div>
                        </div>
                        <div class="d-flex flex-row">
                            <div class="d-flex bg-primary p-2 home-table-sm-header">
                                <label class="fs12-white mb-0">Invoice Amt.</label>
                            </div>
                            <div class="d-flex p-2">
                                <label class="fs12-default mb-0">${{ invoice.invoiceAmount }}</label>
                            </div>
                        </div>
                        <div class="d-flex flex-row">
                            <div class="d-flex bg-primary p-2 home-table-sm-header">
                                <label class="fs12-white mb-0">Invoice Date</label>
                            </div>
                            <div class="d-flex p-2">
                                <label class="fs12-default mb-0">{{ invoice.invoiceDate | date }}</label>
                            </div>
                        </div>
                        <div class="d-flex flex-row">
                            <div class="d-flex bg-primary p-2 home-table-sm-header">
                                <label class="fs12-white mb-0">Due Date</label>
                            </div>
                            <div class="d-flex p-2">
                                <label class="fs12-default mb-0">{{ invoice.invoiceDueDate | date }}</label>
                            </div>
                        </div>
                        <div class="d-flex flex-row">
                            <div class="d-flex bg-primary p-2 home-table-sm-header">
                                <label class="fs12-white mb-0">Status</label>
                            </div>
                            <div class="d-flex p-2">
                                <label class="fs12-default mb-0" v-bind:style="{'color': invoice.invoiceStatusName.includes('Past') ? 'red' : '' }">
                                    {{ invoice.invoiceStatusName }}
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="customer-service-section-sm d-flex flex-column justify-content-center align-items-center">
                <div class="avatar-block">
                    <div></div>
                    <img class="avatar rounded-circle" src="~/Themes/@(themeName)/Content/images/call-avatar.png" alt="profile-default" v-on:click="isCustomerServiceOpen = !isCustomerServiceOpen">
                    <div v-on:click="isCustomerServiceOpen = !isCustomerServiceOpen"></div>
                </div>
                <div class="bg-white d-flex flex-column w-100 align-items-center pb-3 pt-1">
                    <div class="d-flex flex-column w-100 align-items-center" v-on:click="isCustomerServiceOpen = !isCustomerServiceOpen">
                        <label class="title">Outstanding Customer Service</label>
                        <img src="~/Themes/@(themeName)/Content/assets/icn-arrow-up.svg" v-bind:style="{'transform': isCustomerServiceOpen ? 'rotate(180deg)' : ''}" alt="arrow up" width="28">
                    </div>

                    <div v-if="isCustomerServiceOpen">
                        <div class="d-flex flex-column align-items-center justify-content-center my-2">
                            <div class="d-flex flex-row w-100">
                                <label class="h5-primary-600-sans w-40 text-right mr-3">Mon</label>
                                <label class="h5-primary-600-sans">8:00am - 5:00pm</label>
                            </div>
                            <div class="d-flex flex-row w-100">
                                <label class="h5-primary-600-sans w-40 text-right mr-3">Tue</label>
                                <label class="h5-primary-600-sans">8:00am - 5:00pm</label>
                            </div>
                            <div class="d-flex flex-row w-100">
                                <label class="h5-primary-600-sans w-40 text-right mr-3">Wed</label>
                                <label class="h5-primary-600-sans">8:00am - 5:00pm</label>
                            </div>
                            <div class="d-flex flex-row w-100">
                                <label class="h5-primary-600-sans w-40 text-right mr-3">Thur</label>
                                <label class="h5-primary-600-sans">8:00am - 5:00pm</label>
                            </div>
                            <div class="d-flex flex-row w-100">
                                <label class="h5-primary-600-sans w-40 text-right mr-3">Fri</label>
                                <label class="h5-primary-600-sans">8:00am - 5:00pm</label>
                            </div>
                            <div class="d-flex flex-row w-100">
                                <label class="h5-primary-600-sans w-40 text-right mr-3">Sat</label>
                                <label class="h5-primary-600-sans">Closed</label>
                            </div>
                            <div class="d-flex flex-row w-100">
                                <label class="h5-primary-600-sans w-40 text-right mr-3">Sun</label>
                                <label class="h5-primary-600-sans">Closed</label>
                            </div>
                        </div>

                        <label class="h5-default mt-2 mx-5">I'm here to provide you with</label>
                        <label class="h5-default mb-3 mx-5">exceptional customer service.</label>

                        <div class="d-flex flex-row justify-content-center align-items-center mb-3">
                            <a href=tel:@Model.CompanyInfo.SalesContact?.Phone class="d-flex flex-row align-items-end">
                                <img src="~/Themes/@(themeName)/Content/assets/phone.svg" alt="" height="25">
                                <label class="h4-primary ml-2 mr-4 mb-0">Call Us</label>
                            </a>
                            <a href=mailto:@Model.CompanyInfo.SalesContact?.Email class="d-flex flex-row align-items-end">
                                <img src="~/Themes/@(themeName)/Content/assets/mail.svg" alt="" height="25">
                                <label class="h4-primary ml-2 mb-0">Email Us</label>
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <img src="~/Themes/@(themeName)/Content/assets/bg-discount-mobile.png" alt="" width="100%">
        </div>

    </div>

</div>

<script>
    // for mobile view
    let openOrders = @Html.Raw(Serialize(Model.OpenOrders));
    let closedOrders = @Html.Raw(Serialize(Model.ClosedOrders));

    var companyId = @Html.Raw(eRPCompanyId);
   

    console.log("openOrders: ", openOrders);
    console.log("closedOrders: ", closedOrders);

    new Vue({
        el: '#app',
        data: {
            openOrders,
            closedOrders,
            showRecentOrders: true,
            isCustomerServiceOpen: false,
            orderMTRs: []
        },
        methods: {
            showLoading: function () {
                $('#custom-loading').show();
            },
            hideLoading: function () {
                $('#custom-loading').hide();
            },
            handleMtrModal: function (companyId, orderId) {

                const request = {
                    companyId,
                    orderId
                }

                console.log('request', request);
                this.showLoading();
                const self = this;
                $.ajax({
                    url: "@Url.Action("GetOrderMTRs", "HomeOverride")",
                    type: 'GET',
                    data: request,
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (data, _, _) {
                        self.orderMTRs = data.MTRs;
                        console.log('getNotifications - data', self.orderMTRs)
                        viewMtrModal.show();
                        self.hideLoading();
                    },
                    error: function (xhr, thrownError) {
                        self.hideLoading();
                        console.log(xhr, 'error-data', thrownError);
                    }
                });
            }
        },
    });

    function onDialogCreated() {
        viewMtrModal = this;
    }


</script>

<script id="orderNo" type="text/x-template">
    <a href="/orders/${OrderId}">${OrderId}</a>
</script>
<script id="invoiceOrderNo" type="text/x-template">
    <a href="/orders/${OrderNo}">${OrderNo}</a>
</script>
<script id="orderTotal" type="text/x-template">
    $${OrderTotal}
</script>

@functions{
    string DoFormat(decimal myNumber)
    {
        var s = string.Format("{0:N2}", myNumber);

        return s;
    }
}
<ejs-scripts></ejs-scripts>